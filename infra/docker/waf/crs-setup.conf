# ===================
# OWASP CRS SETUP CONFIG
# ===================
# Custom overrides for OWASP Core Rule Set
# These are loaded BEFORE the CRS rules

# ===================
# PARANOIA LEVEL
# ===================
# Level 1: Minimal false positives, basic protection
# Level 2: Few false positives, recommended for most
# Level 3: More false positives, for security-conscious apps
# Level 4: Maximum protection, may need tuning
# Set via env: PARANOIA variable (1-4)
SecAction \
  "id:900000,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.paranoia_level=${PARANOIA}"

# ===================
# ANOMALY SCORING
# ===================
# Inbound threshold (default 5 for paranoia 1)
SecAction \
  "id:900110,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.inbound_anomaly_score_threshold=5,\
   setvar:tx.outbound_anomaly_score_threshold=4"

# ===================
# ALLOWED HTTP METHODS
# ===================
SecAction \
  "id:900200,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE'"

# ===================
# ALLOWED REQUEST CONTENT-TYPES
# ===================
SecAction \
  "id:900220,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|'"

# ===================
# ALLOWED HTTP VERSIONS
# ===================
SecAction \
  "id:900230,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0'"

# ===================
# FILE EXTENSION RESTRICTIONS
# ===================
SecAction \
  "id:900240,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.restricted_extensions=.asa/ .asax/ .ascx/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .rdb/ .resources/ .resx/ .sql/ .swp/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/'"

# ===================
# GEOLOCATION (Optional)
# ===================
# SecGeoLookupDB /etc/modsecurity/GeoIP.dat

# ===================
# SAMPLING MODE (Optional)
# ===================
# Set to 100 for full enforcement, lower to sample
SecAction \
  "id:900400,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.sampling_percentage=100"

# ===================
# APPLICATION SPECIFIC EXCLUSIONS
# ===================
# Exclude Laravel CSRF token from checks
SecRule REQUEST_URI "@beginsWith /sanctum/csrf-cookie" \
    "id:1000001,\
     phase:1,\
     pass,\
     nolog,\
     ctl:ruleRemoveById=941100-941999"

# Exclude API auth endpoints from some checks to prevent false positives
SecRule REQUEST_URI "@beginsWith /api/auth" \
    "id:1000002,\
     phase:1,\
     pass,\
     nolog,\
     ctl:ruleRemoveById=942100-942999"

# Exclude multipart file uploads on run creation
SecRule REQUEST_URI "@rx ^/api/projects/\d+/runs$" \
    "id:1000003,\
     phase:1,\
     pass,\
     nolog,\
     ctl:ruleRemoveById=920420"


