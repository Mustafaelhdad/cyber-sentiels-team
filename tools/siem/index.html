<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple SIEM Tool</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        border-bottom: 2px solid #4CAF50;
        padding-bottom: 10px;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 5px;
      }

      .upload-form {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      input[type="file"],
      input[type="text"] {
        padding: 10px;
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      button {
        background-color: #4CAF50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }

      button:hover {
        background-color: #45a049;
      }

      .alerts {
        margin-top: 20px;
      }

      .alert {
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border-left: 5px solid;
      }

      .alert-critical {
        background-color: #ffebee;
        border-color: #f44336;
      }

      .alert-high {
        background-color: #fff3e0;
        border-color: #ff9800;
      }

      .alert-medium {
        background-color: #fffde7;
        border-color: #ffeb3b;
      }

      .alert-low {
        background-color: #e8f5e9;
        border-color: #4caf50;
      }

      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .dashboard-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .dashboard-card h3 {
        margin: 0;
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
      }

      .dashboard-card .value {
        font-size: 36px;
        font-weight: bold;
        margin: 10px 0;
        color: #333;
      }

      .log-viewer {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
        margin-top: 10px;
      }

      .tab-container {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: 1px solid transparent;
        border-bottom: none;
        background: none;
      }

      .tab.active {
        background: white;
        border-color: #ddd;
        border-bottom-color: white;
        margin-bottom: -1px;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .status-online {
        background-color: #4CAF50;
      }

      .status-offline {
        background-color: #f44336;
      }

      .inline-option {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        color: #555;
        font-size: 14px;
      }

      #realtimeStatus {
        margin-top: 10px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Simple SIEM Tool</h1>

      <div class="dashboard">
        <div class="dashboard-card">
          <h3>Total Logs Processed</h3>
          <div class="value" id="totalLogs">0</div>
        </div>
        <div class="dashboard-card">
          <h3>Active Alerts</h3>
          <div class="value" id="activeAlerts">0</div>
        </div>
        <div class="dashboard-card">
          <h3>High Severity</h3>
          <div class="value" id="highAlerts">0</div>
        </div>
        <div class="dashboard-card">
          <h3>System Status</h3>
          <div class="value">
            <span class="status-indicator status-online"></span>
            <span id="systemStatus">ONLINE</span>
          </div>
        </div>
      </div>

      <div class="tab-container">
        <div class="tab active" data-tab="upload" onclick="switchTab('upload', this)">Upload Logs</div>
        <div class="tab" data-tab="alerts" onclick="switchTab('alerts', this)">Alerts</div>
        <div class="tab" data-tab="logs" onclick="switchTab('logs', this)">Log Viewer</div>
        <div class="tab" data-tab="rules" onclick="switchTab('rules', this)">Rules</div>
        <div class="tab" data-tab="realtime" onclick="switchTab('realtime', this)">Real-time</div>
      </div>

      <!-- Upload Tab -->
      <div id="upload" class="tab-content active">
        <div class="section">
          <h2>Upload Log File for Analysis</h2>
          <div class="upload-form">
            <input type="file" id="logFile">
            <input type="text" id="logSource" placeholder="Source (e.g., firewall, server)" value="firewall">
            <button onclick="uploadLog()">Upload & Analyze</button>
          </div>
          <div id="uploadStatus"></div>
        </div>

        <div class="section">
          <h2>Or Enter Log Manually</h2>
          <textarea id="manualLog" rows="5" style="width: 100%; padding: 10px;"
            placeholder="Enter log entries (one per line) or paste log content here..."></textarea>
          <input type="text" id="manualSource" placeholder="Source" value="manual"
            style="margin-top: 10px; padding: 10px; width: 200px;">
          <button onclick="analyzeManualLog()" style="margin-top: 10px;">Analyze Manual Log</button>
          <div id="manualStatus"></div>
        </div>
      </div>

      <!-- Alerts Tab -->
      <div id="alerts" class="tab-content">
        <div class="section">
          <h2>Security Alerts</h2>
          <div id="alertsContainer" class="alerts">
            <!-- Alerts will be populated here -->
          </div>
        </div>
      </div>

      <!-- Log Viewer Tab -->
      <div id="logs" class="tab-content">
        <div class="section">
          <h2>Log Viewer</h2>
          <div class="log-viewer" id="logViewer">
            <!-- Logs will be displayed here -->
          </div>
        </div>
      </div>

      <!-- Rules Tab -->
      <div id="rules" class="tab-content">
        <div class="section">
          <h2>Detection Rules</h2>
          <div id="rulesContainer">
            <!-- Rules will be populated here -->
          </div>
        </div>
      </div>

      <!-- Real-time Tab -->
      <div id="realtime" class="tab-content">
        <div class="section">
          <h2>Real-time Log Monitoring</h2>
          <div class="upload-form">
            <input type="text" id="realtimeFile" placeholder="Path to log file (server path)">
            <input type="text" id="realtimeSource" placeholder="Source for real-time logs" value="realtime">
            <button onclick="startRealtime()">Start Real-time</button>
            <button onclick="stopRealtime()" style="background-color: #f44336;">Stop Real-time</button>
          </div>
          <div class="inline-option">
            <input type="checkbox" id="realtimeFromStart">
            <label for="realtimeFromStart">Analyze existing content</label>
          </div>
          <div id="realtimeStatus"></div>
          <div class="log-viewer" id="realtimeLogs">
            <!-- Real-time logs will appear here -->
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
      // Detect base path from current URL (e.g., /siem becomes /siem)
      const pathParts = window.location.pathname.split('/').filter(p => p);
      const apiBase = pathParts.length > 0 ? '/' + pathParts[0] : '';
      console.log('API Base Path:', apiBase);

      const socket = io({ path: apiBase + '/socket.io' });
      let realtimeEnabled = false;

      // Socket event handlers
      socket.on('connect', function () {
        console.log('Connected to SIEM server');
        document.getElementById('systemStatus').textContent = 'ONLINE';
      });

      socket.on('alert', function (data) {
        addAlertToUI(data);
        updateDashboard();
        playAlertSound();
      });

      socket.on('log_update', function (data) {
        updateLogViewer(data.logs);
        updateDashboard(data.stats);
      });

      socket.on('realtime_status', function (data) {
        const statusDiv = document.getElementById('realtimeStatus');
        if (!statusDiv) {
          return;
        }
        if (data.success) {
          statusDiv.innerHTML = '<div class="alert alert-low">Real-time monitoring active.</div>';
        } else {
          statusDiv.innerHTML = '<div class="alert alert-high">Error: ' + data.error + '</div>';
          realtimeEnabled = false;
        }
      });

      socket.on('realtime_log', function (data) {
        if (realtimeEnabled) {
          const realtimeLogs = document.getElementById('realtimeLogs');
          realtimeLogs.innerHTML = data.log + '\\n' + realtimeLogs.innerHTML;
        }
      });

      function switchTab(tabName, tabElement) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(tabName).classList.add('active');
        const activeTab = tabElement || document.querySelector(`.tab[data-tab="${tabName}"]`);
        if (activeTab) {
          activeTab.classList.add('active');
        }
      }

      function uploadLog() {
        const fileInput = document.getElementById('logFile');
        const sourceInput = document.getElementById('logSource');
        const statusDiv = document.getElementById('uploadStatus');

        if (!fileInput.files[0]) {
          statusDiv.innerHTML = '<div class="alert alert-medium">Please select a file first!</div>';
          return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('source', sourceInput.value);

        statusDiv.innerHTML = '<div class="alert alert-low">Uploading and analyzing file...</div>';

        fetch(apiBase + '/upload', {
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              statusDiv.innerHTML = `<div class="alert alert-low">✅ File uploaded successfully! Processed ${data.logs_processed} logs, found ${data.alerts_generated} alerts.</div>`;
              loadAlerts();
              loadLogs();
              if (data.stats) {
                updateDashboard(data.stats);
              }
              if (data.report_url) {
                showReportLink('uploadStatus', data.report_url, true);
              }
            } else {
              statusDiv.innerHTML = `<div class="alert alert-high">❌ Error: ${data.error}</div>`;
            }
          })
          .catch(error => {
            statusDiv.innerHTML = `<div class="alert alert-high">❌ Error: ${error}</div>`;
          });
      }

      function analyzeManualLog() {
        const manualLog = document.getElementById('manualLog').value;
        const source = document.getElementById('manualSource').value;

        if (!manualLog.trim()) {
          alert('Please enter some log content!');
          return;
        }

        fetch(apiBase + '/analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            logs: manualLog,
            source: source
          })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert(`✅ Analysis complete! Processed ${data.logs_processed} logs, found ${data.alerts_generated} alerts.`);
              loadAlerts();
              loadLogs();
              if (data.stats) {
                updateDashboard(data.stats);
              }
              if (data.report_url) {
                showReportLink('manualStatus', data.report_url, false);
              }
            } else {
              alert(`❌ Error: ${data.error}`);
            }
          });
      }

      function formatTipInfo(alert) {
        if (!alert.tip || !alert.tip.label) {
          return '';
        }
        const confidence = alert.tip.confidence !== undefined && alert.tip.confidence !== null
          ? ` (${Math.round(alert.tip.confidence * 100)}%)`
          : '';
        return `<br><small>TIP: ${alert.tip.label}${confidence}</small>`;
      }

      function showReportLink(containerId, reportUrl, append) {
        const container = document.getElementById(containerId);
        if (!container || !reportUrl) {
          return;
        }
        const linkHtml = `<div class="alert alert-low">Report ready: <a href="${reportUrl}" target="_blank" rel="noopener">Open HTML summary</a></div>`;
        container.innerHTML = append ? container.innerHTML + linkHtml : linkHtml;
      }

      function loadAlerts() {
        fetch(apiBase + '/alerts')
          .then(response => response.json())
          .then(alerts => {
            const container = document.getElementById('alertsContainer');
            container.innerHTML = '';

            alerts.forEach(alert => {
              const severityClass = `alert-${alert.severity.toLowerCase()}`;
              const alertElement = document.createElement('div');
              alertElement.className = `alert ${severityClass}`;
              alertElement.innerHTML = `
                        <strong>${alert.rule_name}</strong> (${alert.severity})<br>
                        <small>${new Date(alert.timestamp).toLocaleString()}</small><br>
                        ${alert.description}<br>
                        <small>Source: ${alert.source} | Log: ${alert.log_entry.substring(0, 100)}...</small>
                        ${formatTipInfo(alert)}
                    `;
              container.appendChild(alertElement);
            });
          });
      }

      function loadLogs() {
        fetch(apiBase + '/logs')
          .then(response => response.json())
          .then(logs => {
            const viewer = document.getElementById('logViewer');
            viewer.textContent = logs.slice(-50).join('\\n');
          });
      }

      function loadRules() {
        fetch(apiBase + '/rules')
          .then(response => response.json())
          .then(rules => {
            const container = document.getElementById('rulesContainer');
            container.innerHTML = '';

            rules.forEach(rule => {
              const ruleElement = document.createElement('div');
              ruleElement.className = 'alert alert-low';
              ruleElement.innerHTML = `
                        <strong>${rule.name}</strong> (${rule.id})<br>
                        <small>Severity: ${rule.severity}</small><br>
                        ${rule.description}<br>
                        <small>Pattern: ${rule.pattern}</small>
                    `;
              container.appendChild(ruleElement);
            });
          });
      }

      function addAlertToUI(alert) {
        const container = document.getElementById('alertsContainer');
        const severityClass = `alert-${alert.severity.toLowerCase()}`;
        const alertElement = document.createElement('div');
        alertElement.className = `alert ${severityClass}`;
        alertElement.innerHTML = `
                <strong>${alert.rule_name}</strong> (${alert.severity})<br>
                <small>${new Date(alert.timestamp).toLocaleString()}</small><br>
                ${alert.description}<br>
                <small>Source: ${alert.source} | Log: ${alert.log_entry.substring(0, 100)}...</small>
                ${formatTipInfo(alert)}
            `;

        // Add to top
        if (container.firstChild) {
          container.insertBefore(alertElement, container.firstChild);
        } else {
          container.appendChild(alertElement);
        }
      }

      function updateLogViewer(logs) {
        const viewer = document.getElementById('logViewer');
        viewer.textContent = logs.slice(-50).join('\\n');
      }

      function updateDashboard(stats) {
        if (!stats) {
          loadStats();
          return;
        }
        document.getElementById('totalLogs').textContent = stats.total_logs_processed ?? 0;
        document.getElementById('activeAlerts').textContent = stats.total_alerts ?? 0;
        document.getElementById('highAlerts').textContent = stats.high_severity_alerts ?? 0;
        document.getElementById('systemStatus').textContent =
          stats.system_status ? stats.system_status.toUpperCase() : 'ONLINE';
      }

      function loadStats() {
        fetch(apiBase + '/stats')
          .then(response => response.json())
          .then(stats => {
            updateDashboard(stats);
          });
      }

      function playAlertSound() {
        // Play a subtle alert sound
        const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ');
        audio.volume = 0.3;
        audio.play().catch(e => console.log('Audio play failed:', e));
      }

      function startRealtime() {
        const filePath = document.getElementById('realtimeFile').value;
        const source = document.getElementById('realtimeSource').value;
        const fromStart = document.getElementById('realtimeFromStart').checked;
        const statusDiv = document.getElementById('realtimeStatus');

        if (!filePath.trim()) {
          statusDiv.innerHTML = '<div class="alert alert-medium">Please provide a log file path.</div>';
          return;
        }

        realtimeEnabled = true;
        socket.emit('start_realtime', { source: source, file_path: filePath, from_start: fromStart });
        document.getElementById('realtimeLogs').innerHTML = 'Real-time monitoring started...\\n';
      }

      function stopRealtime() {
        realtimeEnabled = false;
        socket.emit('stop_realtime');
        document.getElementById('realtimeLogs').innerHTML += 'Real-time monitoring stopped.\\n';
      }

      // Initial load
      document.addEventListener('DOMContentLoaded', function () {
        loadAlerts();
        loadLogs();
        loadRules();
        loadStats();
        switchTab('upload'); // Ensure upload tab is active on load
      });
    </script>
  </body>

</html>