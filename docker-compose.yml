# ===================
# PRODUCTION DOCKER COMPOSE
# ===================
# For VPS deployment - no host volume mounts, all code embedded in images

services:
  # ===================
  # Flask WAF Proxy
  # ===================
  waf:
    build:
      context: ./tools/waf
      dockerfile: Dockerfile
    container_name: sentinel_waf_flask
    environment:
      - WAF_MAP_FILE=/shared/waf-map.json
      - WAF_HOST=0.0.0.0
      - WAF_PORT=5000
      - WAF_DEBUG=${WAF_DEBUG:-false}
      - WAF_PROXY_TIMEOUT=${WAF_PROXY_TIMEOUT:-30}
    volumes:
      - waf_shared:/shared
      - waf_logs:/app/logs
    networks:
      - sentinel_net
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:5000/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ===================
  # NGINX (Public Gateway)
  # ===================
  nginx:
    build:
      context: ./infra/docker/nginx
      dockerfile: Dockerfile
    container_name: sentinel_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - certbot_www:/var/www/certbot:ro
      - certbot_certs:/etc/nginx/ssl:ro
    depends_on:
      - backend
      - waf
    networks:
      - sentinel_net
    restart: unless-stopped

  # ===================
  # BACKEND (Laravel PHP-FPM)
  # ===================
  backend:
    build:
      context: .
      dockerfile: infra/docker/php/Dockerfile
    container_name: sentinel_backend
    working_dir: /var/www/backend
    environment:
      - APP_NAME=Sentinel
      - APP_ENV=${APP_ENV:-production}
      - APP_KEY=${APP_KEY:-base64:vSvZE7y8wV6beMhp/aMaJgCvdEncsgPvb8ogyDMp7p4=}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_URL=${APP_URL:-http://localhost}
      - LOG_CHANNEL=stack
      - LOG_LEVEL=info
      - DB_CONNECTION=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE:-sentinel}
      - DB_USERNAME=${DB_USERNAME:-sentinel}
      - DB_PASSWORD=${DB_PASSWORD:-secret}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CACHE_DRIVER=redis
      - QUEUE_CONNECTION=redis
      - SESSION_DRIVER=redis
      - WAF_BASE_URL=${WAF_BASE_URL:-https://cybersentinels.cloud}
      - WAF_MAP_FILE_PATH=/shared/waf-map.json
      - WAF_LOG_FILE=/var/log/waf/suspicious.log
      - ZAP_API_URL=http://zap:8080
      - SAST_API_URL=http://sast:8080
      - RASP_API_URL=http://rasp:9000
      - SIEM_API_URL=http://siem:5000
      - AUTH_API_URL=http://auth:5000
      - AUTHZ_API_URL=http://authz:5001
      - PROVISION_API_URL=http://provision:5002
      # In-app RASP configuration
      - RASP_ENABLED=${RASP_ENABLED:-false}
      - RASP_MODE=${RASP_MODE:-monitor}
      - RASP_SINK_DATABASE=${RASP_SINK_DATABASE:-true}
      - RASP_SINK_HTTP=${RASP_SINK_HTTP:-true}
      - RASP_SINK_FILESYSTEM=${RASP_SINK_FILESYSTEM:-true}
      - RASP_QUEUE_CONNECTION=redis
      - RASP_QUEUE_NAME=rasp
      - RASP_LOG_CHANNEL=rasp
      - RASP_LOG_LEVEL=${RASP_LOG_LEVEL:-info}
    volumes:
      - laravel_storage:/var/www/backend/storage
      - reports_artifacts:/var/www/backend/storage/app/reports
      - waf_shared:/shared
      - waf_logs:/var/log/waf:ro
    depends_on:
      - mysql
      - redis
    networks:
      - sentinel_net
    restart: unless-stopped

  # ===================
  # QUEUE WORKER (Laravel Horizon)
  # ===================
  queue:
    build:
      context: .
      dockerfile: infra/docker/php/Dockerfile
    container_name: sentinel_queue
    working_dir: /var/www/backend
    command: php artisan horizon
    environment:
      - APP_NAME=Sentinel
      - APP_ENV=${APP_ENV:-production}
      - APP_KEY=${APP_KEY:-base64:vSvZE7y8wV6beMhp/aMaJgCvdEncsgPvb8ogyDMp7p4=}
      - APP_DEBUG=${APP_DEBUG:-false}
      - DB_CONNECTION=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE:-sentinel}
      - DB_USERNAME=${DB_USERNAME:-sentinel}
      - DB_PASSWORD=${DB_PASSWORD:-secret}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CACHE_DRIVER=redis
      - QUEUE_CONNECTION=redis
      - WAF_MAP_FILE_PATH=/shared/waf-map.json
      - WAF_LOG_FILE=/var/log/waf/suspicious.log
      - SAST_API_URL=http://sast:8080
      - RASP_API_URL=http://rasp:9000
      - SIEM_API_URL=http://siem:5000
      - ZAP_API_URL=http://zap:8080
      - AUTH_API_URL=http://auth:5000
      - AUTHZ_API_URL=http://authz:5001
      - PROVISION_API_URL=http://provision:5002
      # In-app RASP configuration
      - RASP_ENABLED=${RASP_ENABLED:-false}
      - RASP_MODE=${RASP_MODE:-monitor}
      - RASP_SINK_DATABASE=${RASP_SINK_DATABASE:-true}
      - RASP_SINK_HTTP=${RASP_SINK_HTTP:-true}
      - RASP_SINK_FILESYSTEM=${RASP_SINK_FILESYSTEM:-true}
      - RASP_QUEUE_CONNECTION=redis
      - RASP_QUEUE_NAME=rasp
      - RASP_LOG_CHANNEL=rasp
      - RASP_LOG_LEVEL=${RASP_LOG_LEVEL:-info}
    volumes:
      - laravel_storage:/var/www/backend/storage
      - reports_artifacts:/var/www/backend/storage/app/reports
      - waf_shared:/shared
      - waf_logs:/var/log/waf:ro
    depends_on:
      - mysql
      - redis
      - backend
    networks:
      - sentinel_net
    restart: unless-stopped

  # ===================
  # SCHEDULER (Laravel Cron)
  # ===================
  scheduler:
    build:
      context: .
      dockerfile: infra/docker/php/Dockerfile
    container_name: sentinel_scheduler
    working_dir: /var/www/backend
    command: sh -c "while true; do php artisan schedule:run --verbose --no-interaction & sleep 60; done"
    environment:
      - APP_NAME=Sentinel
      - APP_ENV=${APP_ENV:-production}
      - APP_KEY=${APP_KEY:-base64:vSvZE7y8wV6beMhp/aMaJgCvdEncsgPvb8ogyDMp7p4=}
      - APP_DEBUG=${APP_DEBUG:-false}
      - DB_CONNECTION=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE:-sentinel}
      - DB_USERNAME=${DB_USERNAME:-sentinel}
      - DB_PASSWORD=${DB_PASSWORD:-secret}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CACHE_DRIVER=redis
      - QUEUE_CONNECTION=redis
      - WAF_MAP_FILE_PATH=/shared/waf-map.json
      - WAF_LOG_FILE=/var/log/waf/suspicious.log
    volumes:
      - laravel_storage:/var/www/backend/storage
      - reports_artifacts:/var/www/backend/storage/app/reports
      - waf_shared:/shared
      - waf_logs:/var/log/waf:ro
    depends_on:
      - mysql
      - redis
      - backend
    networks:
      - sentinel_net
    restart: unless-stopped

  # ===================
  # MYSQL
  # ===================
  mysql:
    image: mysql:8.0
    container_name: sentinel_mysql
    environment:
      - MYSQL_DATABASE=${DB_DATABASE:-sentinel}
      - MYSQL_USER=${DB_USERNAME:-sentinel}
      - MYSQL_PASSWORD=${DB_PASSWORD:-secret}
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-rootsecret}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - sentinel_net
    restart: unless-stopped

  # ===================
  # REDIS
  # ===================
  redis:
    image: redis:7-alpine
    container_name: sentinel_redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - sentinel_net
    restart: unless-stopped

  # ===================
  # SAST Scanner
  # ===================
  sast:
    build:
      context: ./tools/dast_and_sast
      dockerfile: Dockerfile
    container_name: sentinel_sast
    environment:
      - SAST_RULES_FILE=/app/config/sast_rules.yaml
      - SAST_OUTPUT_DIR=/app/output
      - SAST_SCANS_DIR=/app/scans
      - MAX_UPLOAD_SIZE=${SAST_MAX_UPLOAD_SIZE:-104857600}
    volumes:
      - sast_output:/app/output
      - sast_scans:/app/scans
      - reports_artifacts:/app/reports:rw
    networks:
      - sentinel_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ===================
  # RASP (Runtime App Self-Protection)
  # ===================
  rasp:
    build:
      context: ./tools/RASP
      dockerfile: Dockerfile
    container_name: sentinel_rasp
    environment:
      - RASP_PORT=9000
      - RASP_HOST=0.0.0.0
      - RASP_DB_PATH=/data/rasp_incidents.db
      - RASP_ENABLE_DEMO=${RASP_ENABLE_DEMO:-false}
    volumes:
      - rasp_data:/data
    networks:
      - sentinel_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ===================
  # SIEM (Security Information & Event Management)
  # ===================
  siem:
    build:
      context: ./tools/siem
      dockerfile: Dockerfile
    container_name: sentinel_siem
    environment:
      - SIEM_HOST=0.0.0.0
      - SIEM_PORT=5000
      - SIEM_WORKERS=${SIEM_WORKERS:-2}
      - SIEM_TIMEOUT=${SIEM_TIMEOUT:-120}
      - SIEM_SECRET_KEY=${SIEM_SECRET_KEY:-change-this-in-production}
      - SIEM_TIP_ENABLED=${SIEM_TIP_ENABLED:-false}
      - SIEM_TIP_MODEL_DIR=/app/model
      - SIEM_REALTIME_POLL_INTERVAL=${SIEM_REALTIME_POLL_INTERVAL:-0.5}
    volumes:
      - siem_data:/data
      - siem_logs:/app/logs
      - siem_uploads:/app/uploads
      - siem_reports:/app/reports
    networks:
      - sentinel_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/stats"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ===================
  # Authentication Service
  # ===================
  auth:
    build:
      context: ./tools/Authentication
      dockerfile: Dockerfile
    container_name: sentinel_auth
    environment:
      - AUTH_HOST=0.0.0.0
      - AUTH_PORT=5000
      # Using 1 worker because sessions are stored in-memory
      # Multiple workers would cause session lookup failures
      - AUTH_WORKERS=${AUTH_WORKERS:-1}
      - AUTH_TIMEOUT=${AUTH_TIMEOUT:-60}
      - AUTH_JWT_SECRET=${AUTH_JWT_SECRET:-change-this-in-production}
      - AUTH_JWT_TTL=${AUTH_JWT_TTL:-3600}
      - AUTH_STATIC_OTP=${AUTH_STATIC_OTP:-5555}
      - AUTH_USER_FILE=/data/users.txt
      - AUTH_DEBUG=${AUTH_DEBUG:-false}
    volumes:
      - auth_data:/data
    networks:
      - sentinel_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ===================
  # Authorization Service (RBAC/ABAC)
  # ===================
  authz:
    build:
      context: ./tools/Authorization
      dockerfile: Dockerfile
    container_name: sentinel_authz
    environment:
      - AUTHZ_HOST=0.0.0.0
      - AUTHZ_PORT=5001
      - AUTHZ_WORKERS=${AUTHZ_WORKERS:-2}
      - AUTHZ_TIMEOUT=${AUTHZ_TIMEOUT:-60}
      - AUTHZ_USER_FILE=/data/users.txt
      - AUTHZ_LOG_FILE=/data/authorization.log
      - AUTHZ_DEFAULT_GROUP=${AUTHZ_DEFAULT_GROUP:-general}
      - AUTHZ_ADMIN_PIN=${AUTHZ_ADMIN_PIN:-1234}
      - AUTHZ_DEBUG=${AUTHZ_DEBUG:-false}
    volumes:
      - authz_data:/data
    networks:
      - sentinel_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ===================
  # Account Provisioning Service (IAM)
  # ===================
  provision:
    build:
      context: ./tools/account_provisioning_tool
      dockerfile: Dockerfile
    container_name: sentinel_provision
    environment:
      - PROVISION_HOST=0.0.0.0
      - PROVISION_PORT=5002
      - PROVISION_WORKERS=${PROVISION_WORKERS:-2}
      - PROVISION_TIMEOUT=${PROVISION_TIMEOUT:-60}
      - PROVISION_DB_PATH=/data/users.db
      - PROVISION_REPORTS_DIR=/data/reports
      - PROVISION_DEBUG=${PROVISION_DEBUG:-false}
    volumes:
      - provision_data:/data
    networks:
      - sentinel_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ===================
  # OWASP ZAP (DAST Tool)
  # ===================
  zap:
    image: ghcr.io/zaproxy/zaproxy:stable
    container_name: sentinel_zap
    command: zap.sh -daemon -host 0.0.0.0 -port 8080 -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true -config api.disablekey=true
    mem_limit: 3g
    cpus: "1.5"
    pids_limit: 512
    environment:
      - JAVA_OPTS=-Xmx2048m
    volumes:
      - zap_data:/zap/wrk
    networks:
      - sentinel_net
    healthcheck:
      test:
        ["CMD", "curl", "-f", "http://localhost:8080/JSON/core/view/version/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ===================
  # CERTBOT (SSL Certificate Management)
  # ===================
  certbot:
    image: certbot/certbot:latest
    container_name: sentinel_certbot
    volumes:
      - certbot_www:/var/www/certbot:rw
      - certbot_certs:/etc/letsencrypt:rw
    entrypoint: "/bin/sh -c 'trap exit TERM; if [ ! -f /etc/letsencrypt/live/cybersentinels.cloud/fullchain.pem ]; then certbot certonly --webroot -w /var/www/certbot -d cybersentinels.cloud -d www.cybersentinels.cloud --email admin@cybersentinels.cloud --agree-tos --no-eff-email --non-interactive; fi; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - sentinel_net
    restart: unless-stopped

networks:
  sentinel_net:
    driver: bridge

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  laravel_storage:
    driver: local
  reports_artifacts:
    driver: local
  waf_shared:
    driver: local
  waf_logs:
    driver: local
  certbot_www:
    driver: local
  certbot_certs:
    driver: local
  zap_data:
    driver: local
  sast_output:
    driver: local
  sast_scans:
    driver: local
  rasp_data:
    driver: local
  siem_data:
    driver: local
  siem_logs:
    driver: local
  siem_uploads:
    driver: local
  siem_reports:
    driver: local
  auth_data:
    driver: local
  authz_data:
    driver: local
  provision_data:
    driver: local
